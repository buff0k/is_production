{
 "absolute_value": 0,
 "align_labels_right": 0,
 "creation": "2026-01-14 21:38:56.928422",
 "custom_format": 1,
 "default_print_language": "en",
 "disabled": 0,
 "doc_type": "Hourly Drilling Report",
 "docstatus": 0,
 "doctype": "Print Format",
 "font_size": 14,
 "html": "{# =========================================================\r\n   ERPNext / Frappe Print Format (Jinja)\r\n   Hourly Drilling Report (A4 Landscape)\r\n\r\n   \u2705 Drill Production: ONLY the selected hour (parent hour_slot if set,\r\n      else LAST child row hourly_slot)\r\n   \u2705 Total Meters for Hour = sum of filtered rows\r\n   \u2705 Shift Accumulated = sum of all docs same site/date/shift (safe)\r\n   \u2705 Monthly Statistics = pulled from Drilling Meter Planning safely\r\n   \u2705 All numbers shown with 0 decimals\r\n   ========================================================= #}\r\n\r\n<style>\r\n  @media print { @page { size: A4 landscape; margin: 6mm; } }\r\n  * { box-sizing: border-box; }\r\n  body { font-family: Arial, Helvetica, sans-serif; font-size: 10px; color: #222; }\r\n\r\n  .title { text-align: center; font-size: 16px; font-weight: 700; margin: 0 0 4px 0; color: #1F4E79; }\r\n  .meta { text-align: center; margin: 0 0 6px 0; white-space: nowrap; font-size: 11px; }\r\n\r\n  .pill{\r\n    display:inline-block; padding: 1px 6px; border: 1px solid #888; border-radius: 4px;\r\n    font-weight: bold; min-width: 18px; text-align:center; background:#fff2cc;\r\n  }\r\n\r\n  table.layout { width: 100%; border-collapse: collapse; }\r\n  td.left { width: 74%; vertical-align: top; padding-right: 8px; }\r\n  td.right { width: 26%; vertical-align: top; }\r\n\r\n  .block { border: 1px solid #1f4e79; margin-bottom: 6px; }\r\n  .block-title { background: #1f4e79; color: #fff; padding: 4px 6px; font-weight: 700; font-size: 11px; }\r\n\r\n  table.tbl { width: 100%; border-collapse: collapse; }\r\n  table.tbl th, table.tbl td { border: 1px solid #1f4e79; padding: 4px; text-align: center; vertical-align: middle; }\r\n  table.tbl th { background: #d9e2f3; font-weight: 700; color: #000; }\r\n\r\n  .right-align { text-align: right; }\r\n\r\n  .stats-label { background: #d9e2f3; font-weight: 700; text-align: center; }\r\n  .stats-value { background: #fff2cc; font-weight: 700; text-align: right; width: 70px; }\r\n\r\n  .stats-section { background: #ffffff; font-weight: 800; text-align: center; }\r\n\r\n  .stats-spacer td{\r\n    background: #ffffff;\r\n    height: 10px;\r\n    padding: 0;\r\n    border-left: 1px solid #1f4e79;\r\n    border-right: 1px solid #1f4e79;\r\n  }\r\n\r\n  table.tbl td { line-height: 1.15; }\r\n  .block, table { page-break-inside: avoid; }\r\n</style>\r\n\r\n{# ---------- helpers ---------- #}\r\n{% macro fmt0(n) -%}\r\n  {{ \"{:,.0f}\".format((n or 0)|float) }}\r\n{%- endmacro %}\r\n\r\n{% macro pick(r, a, b, c, d, e, f) -%}\r\n  {% set v = r.get(a) %}\r\n  {% if v is not none and (v|string|trim) != \"\" %}{{ v }}{% else %}\r\n    {% set v = r.get(b) %}\r\n    {% if v is not none and (v|string|trim) != \"\" %}{{ v }}{% else %}\r\n      {% set v = r.get(c) %}\r\n      {% if v is not none and (v|string|trim) != \"\" %}{{ v }}{% else %}\r\n        {% set v = r.get(d) %}\r\n        {% if v is not none and (v|string|trim) != \"\" %}{{ v }}{% else %}\r\n          {% set v = r.get(e) %}\r\n          {% if v is not none and (v|string|trim) != \"\" %}{{ v }}{% else %}\r\n            {% set v = r.get(f) %}\r\n            {% if v is not none and (v|string|trim) != \"\" %}{{ v }}{% else %}{{ \"\" }}{% endif %}\r\n          {% endif %}\r\n        {% endif %}\r\n      {% endif %}\r\n    {% endif %}\r\n  {% endif %}\r\n{%- endmacro %}\r\n\r\n{# =========================================================\r\n   0) Selected hour (parent OR LAST hourly entry)\r\n   ========================================================= #}\r\n{% set all_entries = doc.hourly_entries or [] %}\r\n{% set parent_hour = (doc.hour_slot or \"\")|string|trim %}\r\n\r\n{% set selected_hour = namespace(v=parent_hour) %}\r\n\r\n{# If user did not choose hour_slot manually \u2192 pick LAST row hour #}\r\n{% if selected_hour.v == \"\" and all_entries and (all_entries|length > 0) %}\r\n  {% set selected_hour.v = (all_entries[-1].get(\"hourly_slot\") or \"\")|string|trim %}\r\n{% endif %}\r\n\r\n{# =========================================================\r\n   1) Filter entries: ONLY selected hour (child field = hourly_slot)\r\n   ========================================================= #}\r\n{% set entries = [] %}\r\n{% if selected_hour.v != \"\" %}\r\n  {% for r in all_entries %}\r\n    {% set row_hour = (r.get(\"hourly_slot\") or \"\")|string|trim %}\r\n    {% if row_hour == selected_hour.v %}\r\n      {% set _ = entries.append(r) %}\r\n    {% endif %}\r\n  {% endfor %}\r\n{% endif %}\r\n\r\n{# =========================================================\r\n   2) Build Drill Production rows (aggregated by drill)\r\n   ========================================================= #}\r\n{% set drills_list = [] %}\r\n{% for r in entries %}\r\n  {% set d = (pick(r, \"drill\", \"drills\", \"drill_no\", \"rig\", \"machine\", \"equipment\")|string|trim) %}\r\n  {% if d != \"\" and (d not in drills_list) %}\r\n    {% set _ = drills_list.append(d) %}\r\n  {% endif %}\r\n{% endfor %}\r\n\r\n{% set drill_rows = [] %}\r\n{% set hour_total_m = namespace(v=0.0) %}\r\n\r\n{% if drills_list and (drills_list|length > 0) %}\r\n  {% for d in drills_list %}\r\n    {% set agg = namespace(total=0.0, area=\"\", material=\"\") %}\r\n\r\n    {% for r in entries %}\r\n      {% set rd = (pick(r, \"drill\", \"drills\", \"drill_no\", \"rig\", \"machine\", \"equipment\")|string|trim) %}\r\n      {% if rd == d %}\r\n        {% set m = (r.get(\"meters\") or 0)|float %}\r\n        {% set agg.total = agg.total + m %}\r\n\r\n        {% if (agg.area|trim == \"\") %}\r\n          {% set a = (pick(r, \"area\", \"drilling_area\", \"mining_area\", \"pit\", \"section\", \"location\")|string|trim) %}\r\n          {% if a != \"\" %}{% set agg.area = a %}{% endif %}\r\n        {% endif %}\r\n\r\n        {% if (agg.material|trim == \"\") %}\r\n          {% set mt = (pick(r, \"material\", \"material_type\", \"ore_type\", \"rock_type\", \"ground_type\", \"mat\")|string|trim) %}\r\n          {% if mt != \"\" %}{% set agg.material = mt %}{% endif %}\r\n        {% endif %}\r\n      {% endif %}\r\n    {% endfor %}\r\n\r\n    {% set _ = drill_rows.append({\r\n      \"drill\": d,\r\n      \"area\": agg.area or \"-\",\r\n      \"material\": agg.material or \"-\",\r\n      \"meters\": agg.total\r\n    }) %}\r\n\r\n    {% set hour_total_m.v = hour_total_m.v + agg.total %}\r\n  {% endfor %}\r\n{% endif %}\r\n\r\n{# =========================================================\r\n   3) Shift Accumulated meters (safe)\r\n   ========================================================= #}\r\n{% set shift_accum_m = namespace(v=0.0) %}\r\n{% set TABLE = \"tab\" ~ doc.doctype %}\r\n\r\n{% if doc.site and doc.date and doc.shift %}\r\n  {% set shift_docs = frappe.db.sql(\"\"\"\r\n    SELECT name\r\n    FROM `{table}`\r\n    WHERE site=%s AND date=%s AND shift=%s\r\n      AND docstatus < 2\r\n  \"\"\".format(table=TABLE), (doc.site, doc.date, doc.shift), as_dict=True) %}\r\n\r\n  {% for sd in shift_docs %}\r\n    {% set sdoc = frappe.get_doc(doc.doctype, sd.name) %}\r\n    {% set s_entries = sdoc.hourly_entries or [] %}\r\n    {% for r in s_entries %}\r\n      {% set m = (r.get(\"meters\") or 0)|float %}\r\n      {% set shift_accum_m.v = shift_accum_m.v + m %}\r\n    {% endfor %}\r\n  {% endfor %}\r\n{% endif %}\r\n\r\n{# =========================================================\r\n   4) Monthly Stats (SAFE QUERY)\r\n   ========================================================= #}\r\n{% set dp = None %}\r\n{% if doc.drilling_meter_planning %}\r\n  {% set meta = frappe.get_meta(\"Drilling Meter Planning\") %}\r\n  {% set dp_fields = [] %}\r\n\r\n  {% if meta.has_field(\"monthly_target_meters\") %}{% set _ = dp_fields.append(\"monthly_target_meters\") %}{% endif %}\r\n  {% if meta.has_field(\"daily_target_meters\") %}{% set _ = dp_fields.append(\"daily_target_meters\") %}{% endif %}\r\n  {% if meta.has_field(\"current_daily_meters\") %}{% set _ = dp_fields.append(\"current_daily_meters\") %}{% endif %}\r\n  {% if meta.has_field(\"meters_per_drill\") %}{% set _ = dp_fields.append(\"meters_per_drill\") %}{% endif %}\r\n  {% if meta.has_field(\"required_hourly_rate\") %}{% set _ = dp_fields.append(\"required_hourly_rate\") %}{% endif %}\r\n  {% if meta.has_field(\"current_hourly_rate\") %}{% set _ = dp_fields.append(\"current_hourly_rate\") %}{% endif %}\r\n  {% if meta.has_field(\"mtd_drilled_meters\") %}{% set _ = dp_fields.append(\"mtd_drilled_meters\") %}{% endif %}\r\n  {% if meta.has_field(\"remaining_meter\") %}{% set _ = dp_fields.append(\"remaining_meter\") %}{% endif %}\r\n  {% if meta.has_field(\"drilling_meters_forecast\") %}{% set _ = dp_fields.append(\"drilling_meters_forecast\") %}{% endif %}\r\n\r\n  {% if dp_fields and (dp_fields|length > 0) %}\r\n    {% set dp = frappe.db.get_value(\r\n      \"Drilling Meter Planning\",\r\n      doc.drilling_meter_planning,\r\n      dp_fields,\r\n      as_dict=1\r\n    ) %}\r\n  {% endif %}\r\n{% endif %}\r\n\r\n<div class=\"title\">Hourly Drilling Report</div>\r\n\r\n<div class=\"meta\">\r\n  <b>Site:</b> {{ doc.site or \"-\" }}\r\n  &nbsp;|&nbsp;\r\n  <b>Shift:</b> <span class=\"pill\">{{ doc.shift or \"-\" }}</span>\r\n  &nbsp;|&nbsp;\r\n  <b>Date:</b> {{ doc.date or \"-\" }}\r\n  &nbsp;|&nbsp;\r\n  <b>Hour:</b> {{ selected_hour.v or \"-\" }}\r\n</div>\r\n\r\n<table class=\"layout\">\r\n<tr>\r\n\r\n  <td class=\"left\">\r\n\r\n    <div class=\"block\">\r\n      <div class=\"block-title\">Drill Production (Specific Hour)</div>\r\n      <table class=\"tbl\">\r\n        <thead>\r\n          <tr>\r\n            <th style=\"width: 64px;\">Drills</th>\r\n            <th>Drilling<br>Area</th>\r\n            <th>Material</th>\r\n            <th style=\"width: 56px;\">Meters</th>\r\n          </tr>\r\n        </thead>\r\n        <tbody>\r\n\r\n          {% if selected_hour.v == \"\" %}\r\n            <tr><td colspan=\"4\">No Hour Selected</td></tr>\r\n          {% elif drill_rows and (drill_rows|length > 0) %}\r\n            {% for row in drill_rows %}\r\n              <tr>\r\n                <td>{{ row.drill }}</td>\r\n                <td>{{ row.area }}</td>\r\n                <td>{{ row.material }}</td>\r\n                <td class=\"right-align\">{{ fmt0(row.meters) }}</td>\r\n              </tr>\r\n            {% endfor %}\r\n          {% else %}\r\n            <tr><td colspan=\"4\">No Drill Data Found for {{ selected_hour.v }}</td></tr>\r\n          {% endif %}\r\n\r\n        </tbody>\r\n      </table>\r\n    </div>\r\n\r\n    <div class=\"block\">\r\n      <div class=\"block-title\">Hour Summary</div>\r\n      <table class=\"tbl\">\r\n        <tbody>\r\n          <tr>\r\n            <td class=\"stats-label\">Total Meters for Hour</td>\r\n            <td class=\"stats-value\">{{ fmt0(hour_total_m.v) }}</td>\r\n          </tr>\r\n\r\n          <tr>\r\n            <td class=\"stats-label\">Drill Meters (Shift Accumulated)</td>\r\n            <td class=\"stats-value\">{{ fmt0(shift_accum_m.v) }}</td>\r\n          </tr>\r\n        </tbody>\r\n      </table>\r\n    </div>\r\n\r\n  </td>\r\n\r\n  <td class=\"right\">\r\n    <div class=\"block\">\r\n      <div class=\"block-title\">Monthly Statistics</div>\r\n      <table class=\"tbl\">\r\n        <tbody>\r\n          <tr><td class=\"stats-label\" style=\"text-align:left;\">Monthly Target Meters</td><td class=\"stats-value\">{{ fmt0(dp.get(\"monthly_target_meters\")) if dp else \"-\" }}</td></tr>\r\n          <tr><td class=\"stats-label\" style=\"text-align:left;\">Daily Target Meters</td><td class=\"stats-value\">{{ fmt0(dp.get(\"daily_target_meters\")) if dp else \"-\" }}</td></tr>\r\n          <tr><td class=\"stats-label\" style=\"text-align:left;\">Current Daily Meters</td><td class=\"stats-value\">{{ fmt0(dp.get(\"current_daily_meters\")) if dp else \"-\" }}</td></tr>\r\n          <tr><td class=\"stats-label\" style=\"text-align:left;\">Meters Per Drill</td><td class=\"stats-value\">{{ fmt0(dp.get(\"meters_per_drill\")) if dp else \"-\" }}</td></tr>\r\n\r\n          <tr><td class=\"stats-section\" colspan=\"2\">Penetration Hourly Rate</td></tr>\r\n\r\n          <tr><td class=\"stats-label\" style=\"text-align:left;\">Required Hourly Rate</td><td class=\"stats-value\">{{ fmt0(dp.get(\"required_hourly_rate\")) if dp else \"-\" }}</td></tr>\r\n          <tr><td class=\"stats-label\" style=\"text-align:left;\">Current Hourly Rate</td><td class=\"stats-value\">{{ fmt0(dp.get(\"current_hourly_rate\")) if dp else \"-\" }}</td></tr>\r\n\r\n          <tr class=\"stats-spacer\"><td colspan=\"2\"></td></tr>\r\n\r\n          <tr><td class=\"stats-label\" style=\"text-align:left;\">MTD Drilled Meters</td><td class=\"stats-value\">{{ fmt0(dp.get(\"mtd_drilled_meters\")) if dp else \"-\" }}</td></tr>\r\n          <tr><td class=\"stats-label\" style=\"text-align:left;\">Remaining Meters</td><td class=\"stats-value\">{{ fmt0(dp.get(\"remaining_meter\")) if dp else \"-\" }}</td></tr>\r\n          <tr><td class=\"stats-label\" style=\"text-align:left;\">Drilling Meters Forecast</td><td class=\"stats-value\">{{ fmt0(dp.get(\"drilling_meters_forecast\")) if dp else \"-\" }}</td></tr>\r\n        </tbody>\r\n      </table>\r\n    </div>\r\n  </td>\r\n\r\n</tr>\r\n</table>\r\n",
 "idx": 0,
 "line_breaks": 0,
 "margin_bottom": 15.0,
 "margin_left": 15.0,
 "margin_right": 15.0,
 "margin_top": 15.0,
 "modified": "2026-02-02 17:10:34.310241",
 "modified_by": "eben@isambane.co.za",
 "module": "Production",
 "name": "Hourly Drilling Report",
 "owner": "Administrator",
 "page_number": "Hide",
 "pdf_generator": "wkhtmltopdf",
 "print_format_builder": 0,
 "print_format_builder_beta": 0,
 "print_format_for": "DocType",
 "print_format_type": "Jinja",
 "raw_printing": 0,
 "show_section_headings": 0,
 "standard": "Yes"
}
