{
 "absolute_value": 0,
 "align_labels_right": 0,
 "creation": "2026-01-21 07:46:08.353571",
 "custom_format": 1,
 "default_print_language": "en",
 "disabled": 0,
 "doc_type": "Hourly Production",
 "docstatus": 0,
 "doctype": "Print Format",
 "font_size": 14,
 "html": "<style>\r\n  @media print {\r\n    @page { size: A4 landscape; margin: 10mm; }\r\n  }\r\n\r\n  body {\r\n    font-family: Arial, sans-serif;\r\n    font-size: 11px;\r\n    color: #000;\r\n  }\r\n\r\n  h2.report-title {\r\n    text-align: center;\r\n    color: #1F4E79;\r\n    margin-bottom: 6px;\r\n    font-size: 18px;\r\n  }\r\n\r\n  .header-info {\r\n    text-align: center;\r\n    font-size: 13px;\r\n    margin-bottom: 10px;\r\n    white-space: nowrap;\r\n  }\r\n\r\n  .top-grid {\r\n    display: grid;\r\n    grid-template-columns: 70% 30%;\r\n    grid-gap: 10px;\r\n    width: 100%;\r\n  }\r\n\r\n  table {\r\n    border-collapse: collapse;\r\n    width: 95%;\r\n    margin: 0 auto 10px auto;\r\n  }\r\n\r\n  th, td {\r\n    border: 1px solid #000;\r\n    padding: 3px;\r\n    text-align: center;\r\n    vertical-align: middle;\r\n  }\r\n\r\n  th { background-color: #d9e2f3; }\r\n\r\n  .section-title {\r\n    background-color: #1F4E79;\r\n    color: #fff;\r\n    text-align: left;\r\n    padding: 4px 6px;\r\n    font-size: 12px;\r\n    width: 95%;\r\n    margin: 0 auto;\r\n  }\r\n\r\n  .summary-cell {\r\n    background-color: #fff2cc;\r\n    font-weight: bold;\r\n  }\r\n\r\n  .excavator-table th, .excavator-table td,\r\n  .dozer-table th, .dozer-table td {\r\n    font-size: 10px;\r\n  }\r\n</style>\r\n\r\n<h2 class=\"report-title\">End of Day Production Report</h2>\r\n\r\n<div class=\"header-info\">\r\n  <b>Site:</b> {{ doc.location or '' }} &nbsp;&nbsp;| \r\n  <b>Date:</b> {{ frappe.format_date(doc.prod_date) }} &nbsp;&nbsp;| \r\n  <b>Report:</b> End of Day (All Shifts)\r\n</div>\r\n\r\n{# -----------------------------------------------------------\r\n   1) Load ALL hourly production docs for THIS DAY (all shifts)\r\n   ----------------------------------------------------------- #}\r\n\r\n{% set day_docs = frappe.db.get_all(\r\n    \"Hourly Production\",\r\n    filters={\r\n      \"location\": doc.location,\r\n      \"prod_date\": doc.prod_date,\r\n      \"docstatus\": [\"<\", 2]\r\n    },\r\n    fields=[\"name\", \"shift\"]\r\n) %}\r\n\r\n{% set day_data = [] %}\r\n{% set shifts_included = [] %}\r\n{% for dd in day_docs %}\r\n  {% set full_doc = frappe.get_doc(\"Hourly Production\", dd.name) %}\r\n  {% set _ = day_data.append(full_doc) %}\r\n  {% if dd.shift and dd.shift not in shifts_included %}\r\n    {% set _ = shifts_included.append(dd.shift) %}\r\n  {% endif %}\r\n{% endfor %}\r\n\r\n{# -----------------------------------------------------------\r\n   2) Aggregate excavators/dozers/material totals for the day\r\n   ----------------------------------------------------------- #}\r\n\r\n{% set day_excavators = {} %}\r\n{% set day_dozers = {} %}\r\n{% set geo_layers = {} %}\r\n{% set totals = {\"excavator\": 0, \"dozer\": 0} %}\r\n\r\n{# ---- Excavator volumes from truck loads ---- #}\r\n{% for hour_doc in day_data %}\r\n  {% for row in hour_doc.truck_loads %}\r\n    {% if row.asset_name_shoval and (row.loads or 0) > 0 %}\r\n      {% set mat = (row.geo_mat_layer_truck or \"Unknown\") %}\r\n      {% set key = row.asset_name_shoval ~ \"-\" ~ mat %}\r\n\r\n      {% if not day_excavators.get(key) %}\r\n        {% set _ = day_excavators.update({key: {\r\n          \"excavator\": row.asset_name_shoval,\r\n          \"area\": row.mining_areas_trucks or '',\r\n          \"material\": mat,\r\n          \"bcms\": 0\r\n        }}) %}\r\n      {% endif %}\r\n\r\n      {% set data = day_excavators[key] %}\r\n      {% set vol = ((row.loads or 0) * (row.tub_factor or 0)) %}\r\n      {% set _ = data.update({\"bcms\": data[\"bcms\"] + vol}) %}\r\n      {% set _ = totals.update({\"excavator\": totals[\"excavator\"] + vol}) %}\r\n\r\n      {% if not geo_layers.get(mat) %}\r\n        {% set _ = geo_layers.update({mat: 0}) %}\r\n      {% endif %}\r\n      {% set _ = geo_layers.update({mat: geo_layers[mat] + vol}) %}\r\n    {% endif %}\r\n  {% endfor %}\r\n{% endfor %}\r\n\r\n{# ---- Dozer volumes ---- #}\r\n{% for hour_doc in day_data %}\r\n  {% for row in hour_doc.dozer_production %}\r\n    {% if (row.bcm_hour or 0) > 0 %}\r\n      {% set mat = (row.dozer_geo_mat_layer or \"Unknown\") %}\r\n      {% set key = row.asset_name ~ \"-\" ~ mat %}\r\n\r\n      {% if not day_dozers.get(key) %}\r\n        {% set _ = day_dozers.update({key: {\r\n          \"dozer\": row.asset_name,\r\n          \"area\": row.mining_areas_dozer_child or '',\r\n          \"material\": mat,\r\n          \"bcm\": 0\r\n        }}) %}\r\n      {% endif %}\r\n\r\n      {% set data = day_dozers[key] %}\r\n      {% set vol = (row.bcm_hour or 0) %}\r\n      {% set _ = data.update({\"bcm\": data[\"bcm\"] + vol}) %}\r\n      {% set _ = totals.update({\"dozer\": totals[\"dozer\"] + vol}) %}\r\n    {% endif %}\r\n  {% endfor %}\r\n{% endfor %}\r\n\r\n{% set total_day_bcm = totals[\"excavator\"] + totals[\"dozer\"] %}\r\n\r\n{# -----------------------------------------------------------\r\n   3) Monthly statistics section (reuse your logic)\r\n   NOTE: this depends on doc.month_actual_bcm etc being present\r\n   ----------------------------------------------------------- #}\r\n\r\n{% set survey = frappe.db.sql(\r\n    \"SELECT total_surveyed_coal_tons, last_production_shift_start_date\r\n     FROM `tabSurvey`\r\n     WHERE location=%s\r\n     ORDER BY last_production_shift_start_date DESC LIMIT 1\",\r\n    (doc.location,),\r\n    as_dict=True\r\n) %}\r\n\r\n{% set survey_tons = survey[0].total_surveyed_coal_tons if survey else 0 %}\r\n{% set survey_date = survey[0].last_production_shift_start_date if survey else None %}\r\n\r\n{% set hourly_coal = frappe.db.sql(\r\n    \"SELECT SUM(total_coal_bcm) as total\r\n     FROM `tabHourly Production`\r\n     WHERE location=%s AND prod_date BETWEEN %s AND %s AND docstatus<2\",\r\n    (doc.location, survey_date, doc.prod_date),\r\n    as_dict=True\r\n) %}\r\n\r\n{% set hourly_coal_bcm = hourly_coal[0].total if hourly_coal and hourly_coal[0].total else 0 %}\r\n{% set hourly_coal_tons = hourly_coal_bcm * 1.5 %}\r\n{% set total_coal_tons = (survey_tons or 0) + (hourly_coal_tons or 0) %}\r\n\r\n{% set month_actual_bcm = doc.month_actual_bcm or 0 %}\r\n{% set coal_tons_actual = total_coal_tons or 0 %}\r\n{% set coal_bcm_actual = (coal_tons_actual / 1.5) if coal_tons_actual else 0 %}\r\n{% set waste_bcm_actual = (month_actual_bcm - coal_bcm_actual) if coal_tons_actual else 0 %}\r\n{% set calc_strip_ratio = waste_bcm_actual / coal_tons_actual if coal_tons_actual else 0 %}\r\n\r\n{% set planning = frappe.db.sql(\r\n    \"SELECT month_remaining_production_days\r\n     FROM `tabMonthly Production Planning`\r\n     WHERE location=%s\r\n     ORDER BY creation DESC LIMIT 1\",\r\n    (doc.location,),\r\n    as_dict=True\r\n) %}\r\n\r\n{% set plan_remaining_days = planning[0].month_remaining_production_days if planning and planning[0].month_remaining_production_days else 1 %}\r\n{% set remaining_bcm = (doc.monthly_target_bcm or 0) - (doc.month_actual_bcm or 0) %}\r\n\r\n<div class=\"top-grid\">\r\n\r\n  <div>\r\n    <div class=\"section-title\">Excavator Production (Full Day - All Shifts)</div>\r\n    <table class=\"excavator-table\">\r\n      <thead>\r\n        <tr>\r\n          <th>Excavator</th>\r\n          <th>Mining Area</th>\r\n          <th>Material</th>\r\n          <th>Volume (m\u00b3)</th>\r\n        </tr>\r\n      </thead>\r\n      <tbody>\r\n        {% for key, data in day_excavators.items() %}\r\n        <tr>\r\n          <td>{{ data.excavator }}</td>\r\n          <td>{{ data.area }}</td>\r\n          <td>{{ data.material }}</td>\r\n          <td>{{ data.bcms | int }}</td>\r\n        </tr>\r\n        {% endfor %}\r\n        {% if not day_excavators %}\r\n        <tr><td colspan=\"4\">No Excavator Data</td></tr>\r\n        {% endif %}\r\n      </tbody>\r\n    </table>\r\n\r\n    <div class=\"section-title\">Dozer Production (Full Day - All Shifts)</div>\r\n    <table class=\"dozer-table\">\r\n      <thead>\r\n        <tr>\r\n          <th>Dozer</th>\r\n          <th>Mining Area</th>\r\n          <th>Material</th>\r\n          <th>Volume (m\u00b3)</th>\r\n        </tr>\r\n      </thead>\r\n      <tbody>\r\n        {% for key, data in day_dozers.items() %}\r\n        <tr>\r\n          <td>{{ data.dozer }}</td>\r\n          <td>{{ data.area }}</td>\r\n          <td>{{ data.material }}</td>\r\n          <td>{{ data.bcm | int }}</td>\r\n        </tr>\r\n        {% endfor %}\r\n        {% if not day_dozers %}\r\n        <tr><td colspan=\"4\">No Dozer Data</td></tr>\r\n        {% endif %}\r\n      </tbody>\r\n    </table>\r\n  </div>\r\n\r\n  <div>\r\n    <div class=\"section-title\">Monthly Statistics</div>\r\n    <table>\r\n      <tbody>\r\n        <tr><th>Shifts Included</th><td>{{ shifts_included | join(\", \") if shifts_included else \"N/A\" }}</td></tr>\r\n        <tr><th>Monthly Target BCM</th><td>{{ \"{:,.0f}\".format(doc.monthly_target_bcm or 0) }}</td></tr>\r\n        <tr><th>Daily Target</th><td>{{ \"{:,.0f}\".format(doc.target_bcm_day or 0) }}</td></tr>\r\n        <tr><th>Target Hourly Rate</th><td>{{ \"{:,.0f}\".format(doc.target_bcm_hour or 0) }}</td></tr>\r\n        <tr><th>Production to Date</th><td>{{ \"{:,.0f}\".format(doc.month_actual_bcm or 0) }}</td></tr>\r\n        <tr><th>Remaining BCM</th><td>{{ \"{:,.0f}\".format(remaining_bcm or 0) }}</td></tr>\r\n        <tr><th>Current Rate</th><td>{{ \"{:,.0f}\".format(doc.mtd_bcm_day or 0) }}</td></tr>\r\n        <tr><th>Daily Required Rate</th><td>{{ \"{:,.0f}\".format((remaining_bcm or 0) / (plan_remaining_days or 1)) }}</td></tr>\r\n        <tr><th>Strip Ratio</th><td>{{ \"{:,.2f}\".format(calc_strip_ratio or 0) }}</td></tr>\r\n        <tr><th>Forecasted BCM</th><td>{{ \"{:,.0f}\".format(doc.month_forecated_bcm or 0) }}</td></tr>\r\n      </tbody>\r\n    </table>\r\n  </div>\r\n\r\n</div>\r\n\r\n<div class=\"section-title\">End of Day Summary</div>\r\n\r\n<table>\r\n  <tbody>\r\n    <tr><th>Total BCM TS (Day)</th><td class=\"summary-cell\">{{ totals[\"excavator\"] | int }}</td></tr>\r\n    <tr><th>Total BCM Dozing (Day)</th><td class=\"summary-cell\">{{ totals[\"dozer\"] | int }}</td></tr>\r\n\r\n    <tr><th colspan=\"2\" style=\"background:#d9e2f3; text-align:left;\">TS Material (Day)</th></tr>\r\n\r\n    {% for gl, val in geo_layers.items() %}\r\n      <tr><th>{{ gl }}</th><td>{{ val | int }}</td></tr>\r\n    {% endfor %}\r\n\r\n    <tr><th>Total Day BCM</th><td class=\"summary-cell\">{{ total_day_bcm | int }}</td></tr>\r\n  </tbody>\r\n</table>\r\n",
 "idx": 0,
 "line_breaks": 0,
 "margin_bottom": 15.0,
 "margin_left": 15.0,
 "margin_right": 15.0,
 "margin_top": 15.0,
 "modified": "2026-01-21 07:46:08.353571",
 "modified_by": "Administrator",
 "module": "Production",
 "name": "End Day Shift Report",
 "owner": "Administrator",
 "page_number": "Hide",
 "pdf_generator": "wkhtmltopdf",
 "print_format_builder": 0,
 "print_format_builder_beta": 0,
 "print_format_for": "DocType",
 "print_format_type": "Jinja",
 "raw_printing": 0,
 "show_section_headings": 0,
 "standard": "Yes"
}